<div class="container py-4">
  <!-- Header -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">Loan Questions and Answers</h1>
    <%= link_to "Back to Profile",
                profile_path(current_user),
                class: "btn btn-outline-secondary" %>
  </div>

  <% if @loan_answers.present? %>
    <div class="card mb-4 shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h2 class="h5 mb-0">Loan Questions</h2>
        <%= link_to edit_loan_questions_profile_path,
                    class: "btn btn-sm btn-primary" do %>
          <i class="bi bi-pencil"></i> Edit
        <% end %>
      </div>

      <div class="card-body">
        <dl class="row mb-0">
          <% @loan_answers.each do |question, answer| %>
            <dt class="col-sm-4 fw-semibold mb-2">
              <%= "#{question.position}. " %><%= question.question.to_plain_text %>
              <% if question.required? %>
                <span class="text-danger"> *</span>
              <% end %>
            </dt>
            <dd class="col-sm-8 mb-3">
              <% if question.question_type == "attachments" %>
                <p>
                  <% if answer&.attachments&.attached? %>
                    <% answer.attachments.each do |attachment| %>
                      <div class="d-flex gap-2 align-items-center">
                        <%= link_to("#{attachment.filename.to_s} (PDF)", attachment, target: "_blank", rel: "noopener noreferrer", class: "text-decoration-none", title: "Opens PDF document in new tab", "aria-label": "Open #{attachment.filename.to_s} PDF document in new tab") %><br>
                        <%= link_to delete_attachment_path(attachment), data: { turbo_method: :get, turbo_confirm: 'Are you sure?', turbo_frame: "_top" }, class: "link_to", "aria-label": "Delete #{attachment.filename}" do %>
                          <i class="bi bi-trash-fill text-danger"></i> <span class="visually-hidden">Delete</span>
                        <% end %>
                      </div>
                    <% end %>
                  <% else %>
                    None
                  <% end %>
                </p>
              <% else %>
                <%= answer&.present? ? answer.answer : content_tag(:em, "No answer provided") %>
              <% end %>
            </dd>
          <% end %>
        </dl>
      </div>
    </div>
  <% else %>
    <div class="alert alert-info">
      You haven't answered any loan questions yet.
    </div>
  <% end %>

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">Collection-specific Questions and Answers</h1>
  </div>

  <% if @collection_answers.present? %>
    <% @collection_answers.each do |collection, qa_data| %>
      <!-- Each collection in its own card -->
      <div class="card mb-4 shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h2 class="h5 mb-0"><%= collection.division %></h2>
          <%= link_to collection_questions_profile_path(collection),
                      class: "btn btn-sm btn-primary" do %>
            <i class="bi bi-pencil"></i> Edit
          <% end %>
        </div>

        <div class="card-body">
          <dl class="row mb-0">
            <% qa_data.each do |question, answer| %>
              <dt class="col-sm-4 fw-semibold">
                <%= "#{question.position}. #{question.question.to_plain_text}" %>
                <% if question.required? %>
                  <span class="text-danger"> *</span>
                <% end %>
              </dt>
              <dd class="col-sm-8 mb-3">
                <% if question.question_type == "attachments" %>
                  <p>
                    <% if answer&.attachments&.attached? %>
                      <% answer.attachments.each do |attachment| %>
                        <div class="d-flex gap-2 align-items-center">
                          <%= link_to("#{attachment.filename.to_s} (PDF)", attachment, target: "_blank", rel: "noopener noreferrer", class: "text-decoration-none", title: "Opens PDF document in new tab", "aria-label": "Open #{attachment.filename.to_s} PDF document in new tab") %><br>
                          <%= link_to delete_attachment_path(attachment), data: { turbo_method: :get, turbo_confirm: 'Are you sure?', turbo_frame: "_top" }, class: "link_to", "aria-label": "Delete #{attachment.filename}" do %>
                            <i class="bi bi-trash-fill text-danger"></i> <span class="visually-hidden">Delete</span>
                          <% end %>
                        </div>
                      <% end %>
                    <% else %>
                      None
                    <% end %>
                  </p>
                <% else %>
                  <%= answer&.present? ? answer.answer : content_tag(:em, "No answer provided") %>
                <% end %>
              </dd>
            <% end %>
          </dl>
        </div>
      </div>
    <% end %>
  <% else %>
    <div class="alert alert-info">
      You haven't answered any collection-specific questions yet.
    </div>
  <% end %>
</div>
