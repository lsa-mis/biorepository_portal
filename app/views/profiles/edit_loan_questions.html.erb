<% content_for :title, "Answer Loan Questions" %>

<h1 class="mb-3 text-center">Answer Loan Questions</h1>

<%= form_with url: update_loan_questions_profile_path, method: :patch, multipart: true, local: true do %>
  <div class="card shadow-sm">
    <div class="card-body">
      <% @loan_questions.each do |loan_question| %>
        <% existing_answer = @loan_answers.find { |a| a.loan_question_id == loan_question.id } %>

        <div class="mb-4 p-3 bg-light">
          <% case loan_question.question_type %>
          <% when "text" %>
            <label for=<%= "loan_answers_#{loan_question.id}" %> class="form-label"><%= "#{loan_question.position}. #{strip_tags(loan_question.question)}" %></label>
            <%= content_tag(:span, "*", class: "text-danger") if loan_question.required? %>
            <%= text_field_tag "loan_answers[#{loan_question.id}]",
                existing_answer&.answer&.to_plain_text&.strip || "",
                class: "form-control ms-3" %>

          <% when "checkbox" %>
            <p>
              <%= "#{loan_question.position}. #{strip_tags(loan_question.question)}" %>
              <%= content_tag(:span, "*", class: "text-danger") if loan_question.required? %>
            </p>
            <fieldset>
              <legend class="fs-6">Pick one or more options below</legend>
              <% loan_question.options.each do |option| %>
                <div class="form-check ms-3">
                  <input type="checkbox" name="loan_answers[<%= loan_question.id %>][]" value="<%= option.value %>" id="loan_answers_<%= loan_question.id %>_<%= option.id %>_"
                    <%= 'checked' if (existing_answer&.answer&.to_plain_text&.strip || "").to_s.include?(option.value) %> />
                  <%= label_tag "loan_answers_#{loan_question.id}_#{option.id}_", option.value, class: "form-check-label" %>
                </div>
              <% end %>
            </fieldset>

          <% when "dropdown" %>
            <label for=<%= "loan_answers_#{loan_question.id}" %> class="form-label"><%= "#{loan_question.position}. #{strip_tags(loan_question.question)}" %></label>
            <%= content_tag(:span, "*", class: "text-danger") if loan_question.required? %>
            <%= select_tag "loan_answers[#{loan_question.id}]",
                options_for_select(loan_question.options.map(&:value), existing_answer&.answer&.to_plain_text&.strip || ""),
                class: "form-select ms-3", prompt: "Select..." %>
          
          <% when "attachments" %>
            <p>
              <%= "#{loan_question.position}. #{strip_tags(loan_question.question)}" %>
              <%= content_tag(:span, "*", class: "text-danger") if loan_question.required? %>
            </p>
            <div>
              <span class="body-text">Currently Attached:</span>
              <% if existing_answer&.attachments&.attached? %>
                <% existing_answer.attachments.each do |attachment| %>
                  <div class="ms-3">
                    <%= link_to("#{h(attachment.filename.to_s)} (PDF)", attachment, target: "_blank", rel: "noopener noreferrer", class: "text-decoration-none", title: "Opens PDF document in new tab", "aria-label": "Open #{h(attachment.filename.to_s)} PDF document in new tab") %>
                    <%= link_to delete_attachment_path(attachment), data: { turbo_method: :get, turbo_confirm: 'Are you sure?', turbo_frame: "_top" }, class: "link_to", "aria-label": "Delete #{h(attachment.filename.to_s)}" do %>
                      <i class="bi bi-trash-fill text-danger"></i> <span class="visually-hidden">Delete</span>
                    <% end %>
                  </div>
                <% end %>
              <% else %>
                None
              <% end %>
            </div>
            <div>
              <span class="body-text">Upload New Attachments (PDF only):</span>
              <%= file_field_tag "loan_answers[#{loan_question.id}][]", accept: ".pdf", class: "form-control ms-3 mt-2", multiple: true, "aria-label": "Upload new attachments for #{loan_question.question}" %>
            </div>

          <% else %>
            <div class="alert alert-warning mt-3">
              <strong>Unsupported question type:</strong> <%= loan_question.question_type %>
            </div>
          <% end %>
        </div>
      <% end %>
      <div class="mb-3">
        <%= submit_tag "Submit", class: "btn btn-primary" %>
        <%= link_to "Cancel", show_collections_questions_profile_path, class: "link_to" %>
      </div>
    </div>
  </div>
<% end %>
